module.exports=function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=7)}([function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=n(11),i=r(n(16));e.default=function(t="default"){const e=i.default[t]||i.default.default,{driver:n,host:r,port:u,database:s,user:a,password:c}=e;return(new(0,o(`./${n}.ts`).default)).init(r,u,s,a,c)}},function(t,e){t.exports=require("path")},function(t,e){t.exports=require("bcrypt")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.withMiddleware=void 0;e.withMiddleware=(t,...e)=>()=>{const n=t();return Object.defineProperty(n,"middleware",{enumerable:!1,value:e}),n}},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=n(2),u=o(n(5)),s=o(n(0));class a extends u.default{constructor(){super(...arguments),this.table="users"}authenticate(t,e){return r(this,void 0,void 0,(function*(){const n=yield s.default(),r=(yield n.query(`\n      select * from ${this.table} where email=$1 limit 1\n    `,[t])).rows[0];if(!r)throw new Error("Unauthenticated");const{id:o,password:u}=r;if(!(yield i.compare(e,u)))throw new Error("Unauthenticated");return o}))}}a.routeAlias="users",e.default=a},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=o(n(0));e.default=class{constructor(){return this.table="",new Proxy(this,{get:(t,e)=>{if(!this.table)throw new Error(`Table of ${this.constructor.name} is undefined! Define it in your model class!`);return t[e]}})}list(t={}){return r(this,void 0,void 0,(function*(){const t=yield i.default();return(yield t.query(`\n      select * from ${this.table}\n    `)).rows}))}getById(t){return r(this,void 0,void 0,(function*(){const e=yield i.default();return(yield e.query(`\n      select * from ${this.table} where id=$1 limit 1\n    `,[t])).rows[0]}))}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.default=(t,e,n)=>{const{session:r,xhr:o}=t,{userId:i}=r;i?n():o?e.status(302).send({redirect:"/login"}):e.redirect("/login")}},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.runCommand=e.bootstrap=void 0;const i=o(n(8));e.runCommand=i.default;const u=o(n(20)),s=o(n(25)),a=o(n(33));e.bootstrap=function(t){return r(this,void 0,void 0,(function*(){yield u.default(),a.default(t),new s.default(t)}))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const r=n(9);e.default=function(t,e){return(0,r(`./${t}.ts`).default)(e)}},function(t,e,n){var r={"./create.admin.ts":10,"./notes.seed.ts":18};function o(t){var e=i(t);return n(e)}function i(t){if(!n.o(r,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return r[t]}o.keys=function(){return Object.keys(r)},o.resolve=i,t.exports=o,o.id=9},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=o(n(0)),u=n(2);e.default=function(){return r(this,void 0,void 0,(function*(){const t=yield i.default(),e=yield u.hash("123456",5);return yield t.query("\n      insert into users (name, email, password)\n      values ($1, $2, $3)\n  ",["Admin","admin@jsway.ru",e]),0}))}},function(t,e,n){var r={"./pgsql.ts":12};function o(t){var e=i(t);return n(e)}function i(t){if(!n.o(r,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return r[t]}o.keys=function(){return Object.keys(r)},o.resolve=i,t.exports=o,o.id=11},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=n(13),u=o(n(14)),s=o(n(15));class a{get connection(){return a._client}init(t,e,n,o,c){return r(this,void 0,void 0,(function*(){if(!a._client){(yield s.default(`${t}:${e}`))||(yield u.default({host:t,port:e,timeout:15e3}));const r=new i.Client({host:t,port:e,database:n,user:o,password:c});yield r.connect(),a._client=r}return this}))}query(t,e){return r(this,void 0,void 0,(function*(){return this.connection.query(t,e)}))}}e.default=a},function(t,e){t.exports=require("pg")},function(t,e){t.exports=require("wait-port")},function(t,e){t.exports=require("is-reachable")},function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=r(n(17)),{DB_CONNECTION:i="pgsql",DB_HOST:u="localhost",DB_PORT:s=5432,DB_NAME:a="postgres",DB_USER:c="postgres",DB_PASSWORD:l=""}=o.default(process.env),f={default:{driver:i,host:u,port:s,database:a,user:c,password:l}};e.default=f},function(t,e){t.exports=require("dotenv-parse-variables")},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=o(n(0)),u=n(19);e.default=function(){return r(this,void 0,void 0,(function*(){const t=yield i.default();for(let e in Array.from(Array(3)))yield t.query("\n      insert into notes (title, description) values ($1, $2)\n    ",[u.lorem.word(),u.lorem.paragraphs()]);return 0}))}},function(t,e){t.exports=require("faker")},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const o=n(1),i=n(21),u=n(22);e.default=function(){return r(this,void 0,void 0,(function*(){const t=o.resolve("/home/dunloop/www/@jsway/planner/storage","migrations.json"),e=i.existsSync(t)?JSON.parse(i.readFileSync(t).toString()):{},n=yield u.keys().sort((t,e)=>{const[{birthtimeMs:n},{birthtimeMs:r}]=[t,e].map(t=>i.statSync(o.resolve("/home/dunloop/www/@jsway/planner/src/backend/migrations",t)));return n-r}).reduce((t,n)=>t.then(t=>r(this,void 0,void 0,(function*(){const r=o.parse(n).name;if(e[r])return t;const i=new(0,u(n).default);return yield i.up(),t[r]={key:r,time:(new Date).toLocaleString("ru")},t}))),Promise.resolve({}));i.writeFileSync(t,JSON.stringify(Object.assign(Object.assign({},e),n),null,2))}))}},function(t,e){t.exports=require("fs")},function(t,e,n){var r={"./create.notes.table.ts":23,"./create.users.table.ts":24};function o(t){var e=i(t);return n(e)}function i(t){if(!n.o(r,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return r[t]}o.keys=function(){return Object.keys(r)},o.resolve=i,t.exports=o,o.id=22},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.down=e.up=void 0;const i=o(n(0));e.up=function(){return r(this,void 0,void 0,(function*(){return(yield i.default()).query("\n    create table notes (\n      id bigserial not null constraint notes_pkey primary key,\n      title varchar(255) not null,\n      description text\n    );\n  ")}))},e.down=function(){return r(this,void 0,void 0,(function*(){}))}},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=o(n(0));e.default=class{up(){return r(this,void 0,void 0,(function*(){return(yield i.default()).query("\n      create table users (\n        id bigserial not null constraint users_pkey primary key,\n        name varchar(255) not null,\n        email varchar(255) not null constraint users_email_unique unique,\n        password varchar(255) not null,\n        auth_token varchar(100),\n        active boolean default true not null\n      );\n    ")}))}down(){}}},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const o=n(1),i=n(26);e.default=class{constructor(t){this.app=t;for(let t of i.keys())this.handleController(t)}handleController(t){const e=i(t).default,n=o.parse(t).name,r=Array.isArray(e)?e:[e];for(let t of r){const e="index"!==n?n:void 0;this.handleRoutes(t,e)}}handleRoutes(t,e){const n=t();for(let t of n)this.handleRoute(t,{prefix:e,handlers:n.middleware})}handleRoute(t,e){const{prefix:n,handlers:i}=e,{method:u,path:s,response:a}=t,c=u,l="string"==typeof s?o.join("/"+(n||""),s):s;this.app[c](l,...i||[],(t,e,n)=>r(this,void 0,void 0,(function*(){if("function"==typeof a){const{error:n,message:r}=yield a(t).then(t=>({error:!1,message:t})).catch(({message:t})=>({error:!0,message:t}));e.status(n?404:200).send(r)}else n()})))}}},function(t,e,n){var r={"./api.ts":27,"./index.ts":32};function o(t){var e=i(t);return n(e)}function i(t){if(!n.o(r,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return r[t]}o.keys=function(){return Object.keys(r)},o.resolve=i,t.exports=o,o.id=26},function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function u(t){try{a(r.next(t))}catch(t){i(t)}}function s(t){try{a(r.throw(t))}catch(t){i(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(u,s)}a((r=r.apply(t,e||[])).next())}))},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),u=n(28),s=o(n(29)),a=n(3),c=o(n(4)),l=o(n(6)),f=s.default.json();e.default=[a.withMiddleware(()=>[{method:"post",path:"/login",response:({session:t,body:e})=>r(void 0,void 0,void 0,(function*(){const{login:n,password:r}=e,o=yield(new c.default).authenticate(n,r);return o&&(t.userId=o,t.accessToken=u.randomBytes(24).toString("hex")),o}))}],f),a.withMiddleware(()=>{const t=n(30),e=t.keys().reduce((e,n)=>{const r=t(n).default,{routeAlias:o}=r||{};return e[o||i.parse(n).name]=r,e},{}),o=`/:model(${Object.keys(e).join("|")})`;return[{method:"get",path:i.resolve(o),response:({params:t})=>r(void 0,void 0,void 0,(function*(){const{model:n}=t;return(new(0,e[n])).list()}))},{method:"get",path:i.resolve(o,":id"),response:({params:t})=>r(void 0,void 0,void 0,(function*(){const{model:n,id:r}=t;return(new(0,e[n])).getById(r)}))}]},f,l.default)]},function(t,e){t.exports=require("crypto")},function(t,e){t.exports=require("express")},function(t,e,n){var r={"./note.ts":31,"./user.ts":4};function o(t){var e=i(t);return n(e)}function i(t){if(!n.o(r,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return r[t]}o.keys=function(){return Object.keys(r)},o.resolve=i,t.exports=o,o.id=30},function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=r(n(5));class i extends o.default{constructor(){super(...arguments),this.table="notes"}}i.routeAlias="notes",e.default=i},function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=n(3),i=r(n(6));e.default=o.withMiddleware(()=>[{method:"get",path:/\/(?!login).*/}],i.default)},function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=r(n(34));e.default=function(t){t.use(o.default({secret:"session-secret"}))}},function(t,e){t.exports=require("express-session")}]);